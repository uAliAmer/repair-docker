<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8">
    <title>Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ ØµÙŠØ§Ù†Ø© Ø¬Ø¯ÙŠØ¯</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Cairo Font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Liquid Glass Design System CSS -->
    <link rel="stylesheet" href="liquid-glass.css">

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="api-client.js"></script>
    <style>
        /* ============================================================
           PAGE-SPECIFIC STYLES FOR REPAIR FORM
           ============================================================ */


body {
    font-family: var(--font-family);
    font-size: var(--font-size-base);
    color: var(--color-text);
    background: var(--color-bg);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
}

.app-container {
    width: 100%;
    max-width: 800px;
    margin: 0 auto;
    padding: var(--space-lg);
}

.page-header {
    text-align: center;
    margin-bottom: var(--space-xl);
    padding: var(--space-xl);
    background: var(--color-surface-elevated);
    backdrop-filter: blur(var(--blur-md));
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-glass);
    border: 1px solid var(--color-border-light);
}

.page-header h1 {
    font-family: var(--font-family-display);
    font-size: var(--font-size-xxl);
    font-weight: 600;
    margin-bottom: var(--space-sm);
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.page-header p {
    color: var(--color-text-secondary);
    font-size: var(--font-size-base);
}

.card {
    background: var(--color-surface-elevated);
    backdrop-filter: blur(var(--blur-md));
    border-radius: var(--radius-xl);
    padding: var(--space-xl);
    box-shadow: var(--shadow-glass);
    border: 1px solid var(--color-border-light);
    margin-bottom: var(--space-lg);
}

/* QR Scanner Section */
.qr-scanner-section {
    margin-bottom: var(--space-xl);
}

.qr-scanner-card {
    background: linear-gradient(135deg, rgba(0, 122, 255, 0.1) 0%, rgba(94, 92, 230, 0.1) 100%);
    border: 2px dashed var(--color-primary);
    border-radius: var(--radius-xl);
    padding: var(--space-xl);
    text-align: center;
}

.qr-scanner-card.scanned {
    background: linear-gradient(135deg, rgba(52, 199, 89, 0.1) 0%, rgba(90, 200, 250, 0.1) 100%);
    border-color: var(--color-success);
}

.qr-scanner-card h3 {
    font-size: var(--font-size-lg);
    font-weight: 600;
    margin-bottom: var(--space-md);
    color: var(--color-primary);
}

.qr-scanner-card.scanned h3 {
    color: var(--color-success);
}

#reader {
    max-width: 500px;
    margin: 0 auto var(--space-md);
    border-radius: var(--radius-md);
    overflow: hidden;
}

.scanned-id-display {
    background: var(--color-surface-elevated);
    padding: var(--space-lg);
    border-radius: var(--radius-md);
    margin-top: var(--space-md);
}

.scanned-id-display h4 {
    color: var(--color-success);
    font-size: var(--font-size-lg);
    margin-bottom: var(--space-sm);
}

.scanned-id-display .repair-id {
    font-family: var(--font-mono);
    font-size: var(--font-size-xl);
    font-weight: 700;
    color: var(--color-primary);
    background: rgba(0, 122, 255, 0.1);
    padding: var(--space-md);
    border-radius: var(--radius-sm);
    display: inline-block;
}

/* Form Styles */
.form-group {
    margin-bottom: var(--space-lg);
}

.form-label {
    display: block;
    font-weight: 600;
    font-size: var(--font-size-base);
    color: var(--color-text);
    margin-bottom: var(--space-sm);
}

.form-input,
.form-textarea,
.form-select {
    width: 100%;
    padding: var(--space-md);
    font-family: var(--font-family);
    font-size: var(--font-size-base);
    color: var(--color-text);
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    transition: all var(--transition-base);
    outline: none;
}

.form-input:focus,
.form-textarea:focus,
.form-select:focus {
    border-color: var(--color-primary);
    background: rgba(255, 255, 255, 1);
    box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
}

.form-input:disabled,
.form-textarea:disabled,
.form-select:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: rgba(200, 200, 200, 0.3);
}

.form-textarea {
    min-height: 80px;
    resize: vertical;
}

.form-select {
    cursor: pointer;
    appearance: none;
    background-image: url('data:image/svg+xml;charset=UTF-8,<svg width="12" height="8" viewBox="0 0 12 8" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1L6 6L11 1" stroke="%231D1D1F" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>');
    background-repeat: no-repeat;
    background-position: left var(--space-md) center;
    padding-left: var(--space-xl);
}

/* Image Upload Section */
.image-upload-card {
    background: linear-gradient(135deg, rgba(94, 92, 230, 0.05) 0%, rgba(191, 90, 242, 0.05) 100%);
    border: 2px dashed var(--color-accent);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    text-align: center;
    margin-bottom: var(--space-lg);
}

.image-upload-card h3 {
    font-size: var(--font-size-lg);
    font-weight: 600;
    margin-bottom: var(--space-sm);
    color: var(--color-accent);
}

.text-muted {
    color: var(--color-text-secondary);
    font-size: var(--font-size-sm);
}

.mb-md {
    margin-bottom: var(--space-md);
}

input[type="file"] {
    display: none;
}

.upload-button {
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-md) var(--space-xl);
    background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-dark) 100%);
    color: white;
    border: none;
    border-radius: var(--radius-full);
    font-size: var(--font-size-base);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-base);
    box-shadow: var(--shadow-sm);
}

.upload-button:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

#imagePreview {
    display: none;
    max-width: 100%;
    max-height: 400px;
    margin-top: var(--space-md);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-md);
}

.image-info {
    margin-top: var(--space-md);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
}

.remove-image-btn {
    display: none;
    margin-top: var(--space-md);
    padding: var(--space-sm) var(--space-md);
    background: var(--color-error);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: all var(--transition-base);
}

.remove-image-btn:hover {
    background: #d32f2f;
}

/* Buttons */
.btn {
    padding: var(--space-md) var(--space-xl);
    font-family: var(--font-family);
    font-size: var(--font-size-base);
    font-weight: 600;
    color: white;
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
    border: none;
    border-radius: var(--radius-full);
    cursor: pointer;
    transition: all var(--transition-base);
    box-shadow: var(--shadow-sm);
    width: 100%;
}

.btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.btn:active:not(:disabled) {
    transform: translateY(0);
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-secondary {
    background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-dark) 100%);
    margin-top: var(--space-md);
}

.btn-success {
    background: linear-gradient(135deg, var(--color-success) 0%, #2d9c4e 100%);
}

/* Loading Overlay */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(10px);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Success Display */
#successDisplay {
    display: none;
    text-align: center;
}

.success-icon {
    font-size: 64px;
    margin-bottom: var(--space-lg);
    animation: scaleIn 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
}

@keyframes scaleIn {
    from {
        transform: scale(0);
        opacity: 0;
    }
    to {
        transform: scale(1);
        opacity: 1;
    }
}

.success-message {
    font-size: var(--font-size-xl);
    font-weight: 600;
    color: var(--color-success);
    margin-bottom: var(--space-lg);
}

.success-repair-id {
    font-family: var(--font-mono);
    font-size: var(--font-size-xxl);
    font-weight: 700;
    color: var(--color-primary);
    background: rgba(0, 122, 255, 0.1);
    padding: var(--space-lg);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-xl);
    display: inline-block;
}

.success-status {
    font-size: var(--font-size-lg);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-xl);
}

/* Responsive Design */
@media (max-width: 768px) {
    .app-container {
        padding: var(--space-md);
    }

    .page-header {
        padding: var(--space-lg);
    }

    .page-header h1 {
        font-size: var(--font-size-xl);
    }

    .card {
        padding: var(--space-lg);
    }
}

@media print {
    body * {
        visibility: hidden;
    }
    #successDisplay, #successDisplay * {
        visibility: visible;
    }
    #successDisplay {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
    }
    .btn {
        display: none;
    }
}
    </style>
  </head>
  <body>
    <div class="app-container">
      <div class="page-header">
        <h1>ğŸ› ï¸ Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ ØµÙŠØ§Ù†Ø© Ø¬Ø¯ÙŠØ¯</h1>
        <p>Ø§Ù…Ø³Ø­ Ø±Ù…Ø² QR Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø§Ù…Ù„Ø£ Ø§Ù„ØªÙØ§ØµÙŠÙ„</p>
      </div>

      <!-- QR Scanner Section -->
      <div class="qr-scanner-section" id="qrScannerSection">
        <div class="qr-scanner-card" id="qrScannerCard">
          <h3 id="scannerTitle">ğŸ“· Ø§Ù…Ø³Ø­ Ø±Ù…Ø² QR Ø§Ù„Ù…Ø·Ø¨ÙˆØ¹ Ù…Ø³Ø¨Ù‚Ø§Ù‹</h3>
          <p class="text-muted mb-md">Ø§Ø³ØªØ®Ø¯Ù… ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„Ù…Ø³Ø­ Ø±Ù…Ø² QR Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„ØµÙ‚</p>
          <div id="reader"></div>
          <button type="button" class="btn btn-secondary" id="startScanBtn" onclick="startScanning()">
            ğŸ“¸ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­
          </button>
          <div id="scannedIdDisplay" class="scanned-id-display" style="display: none;">
            <h4>âœ… ØªÙ… Ù…Ø³Ø­ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­</h4>
            <div class="repair-id" id="scannedRepairId"></div>
          </div>
        </div>
      </div>

      <!-- Repair Form -->
      <div class="card" id="formCard">
        <form id="repairForm" onsubmit="handleSubmit(event)">
          <div class="form-group">
            <label class="form-label">ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
            <input name="date" type="date" required id="date" class="form-input" disabled>
          </div>

          <div class="form-group">
            <label class="form-label">ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
            <textarea name="customer" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„..." required class="form-textarea" disabled></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">ğŸ“± Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„ <img width="18" height="18" src="https://img.icons8.com/color/48/whatsapp--v6.png" alt="whatsapp" style="vertical-align: middle; margin-left: 4px;"/></label>
            <input name="phone" type="tel" placeholder="07745557861" required class="form-input" disabled>
            <small style="display: block; margin-top: 4px; color: var(--color-text-secondary); font-size: var(--font-size-sm);">* ÙŠØ¬Ø¨ Ø§Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ø±Ù‚Ù… Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨</small>
          </div>

          <div class="form-group">
            <label class="form-label">ğŸ“¦ Ø§Ù„Ø¬Ù‡Ø§Ø²</label>
            <textarea name="device" placeholder="Ù…Ø«Ø§Ù„: GSTAR 4 Gang GoldØŒ Sonoff Basic" required class="form-textarea" disabled></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">â— Ø§Ù„Ù…Ø´ÙƒÙ„Ø© / Ø§Ù„Ø¹Ø·Ù„</label>
            <textarea name="issue" placeholder="Ø§ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù‡Ù†Ø§..." class="form-textarea" style="min-height: 120px;" disabled></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">ğŸ¢ Ø§Ù„ÙØ±Ø¹</label>
            <select name="branch" required class="form-select" dir="rtl" disabled>
              <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹</option>
              <option>Ø¹ÙƒØ¯ Ø§Ù„Ù†ØµØ§Ø±Ù‰</option>
              <option>Ø¨Ø§Ø¨Ù„ÙˆÙ† Ù…ÙˆÙ„</option>
              <option>ÙƒÙ…Ø¨ Ø³Ø§Ø±Ø©</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">ğŸ›¡ï¸ Ø§Ù„Ø¶Ù…Ø§Ù†</label>
            <select name="warranty" required class="form-select" disabled>
              <option value="">Ø§Ø®ØªØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¶Ù…Ø§Ù†</option>
              <option>Ù†Ø¹Ù…</option>
              <option>Ù„Ø§</option>
            </select>
          </div>

          <!-- Image Upload Section -->
          <div class="image-upload-card">
            <h3>ğŸ“¸ ØµÙˆØ±Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²</h3>
            <p class="text-muted mb-md">Ø§Ù„ØªÙ‚Ø· ØµÙˆØ±Ø© Ù„ØªÙˆØ«ÙŠÙ‚ Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²</p>

            <input type="file" id="deviceImage" accept="image/*" capture="camera" disabled>
            <label for="deviceImage" class="upload-button" id="uploadButtonLabel" style="opacity: 0.5; cursor: not-allowed;">
              <span>ğŸ“·</span>
              <span>Ø§Ù„ØªÙ‚Ø·/Ø§Ø±ÙØ¹ ØµÙˆØ±Ø©</span>
            </label>

            <div class="image-info" id="imageInfo"></div>
            <img id="imagePreview" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²">
            <button type="button" class="remove-image-btn" id="removeImageBtn">âœ• Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø©</button>
          </div>

          <button type="submit" class="btn" id="submitBtn" disabled>
            â• Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ ØµÙŠØ§Ù†Ø©
          </button>
        </form>
      </div>

      <!-- Success Display -->
      <div class="card" id="successDisplay">
        <div class="success-icon">âœ…</div>
        <div class="success-message">ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!</div>
        <div class="success-repair-id" id="successRepairId"></div>
        <div class="success-status" id="successStatus"></div>
        <button type="button" class="btn btn-success" onclick="startNewRepair()">
          âœ¨ Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
        </button>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
    </div>

    <script>
      // Global variables
      let uploadedImageFile = null; // Store File object instead of base64
      let scannedRepairId = null;
      let html5QrCode = null;

      // Set default date to today
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;

      // Beep sound function for QR scan success
      function playBeep() {
        try {
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);

          // High-pitched beep at 1200Hz
          oscillator.frequency.value = 1200;
          oscillator.type = 'sine';

          // Loud volume
          gainNode.gain.value = 0.8;

          // Play beep for 200ms
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.2);

          // Cleanup
          setTimeout(() => {
            oscillator.disconnect();
            gainNode.disconnect();
            audioContext.close();
          }, 300);
        } catch (error) {
          console.error('Failed to play beep:', error);
        }
      }

      // Start QR scanning (only when user clicks the scan button)
      function startScanning() {
        const readerElement = document.getElementById('reader');

        if (html5QrCode) {
          // Scanner already initialized, just start
          html5QrCode.start(
            { facingMode: "environment" },
            {
              fps: 10,
              qrbox: { width: 250, height: 250 }
            },
            onScanSuccess,
            onScanFailure
          ).catch(err => {
            console.error('Error starting scanner:', err);
            alert('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ' + err);
          });
        } else {
          // Initialize scanner
          html5QrCode = new Html5Qrcode("reader");
          html5QrCode.start(
            { facingMode: "environment" },
            {
              fps: 10,
              qrbox: { width: 250, height: 250 }
            },
            onScanSuccess,
            onScanFailure
          ).catch(err => {
            console.error('Error initializing scanner:', err);
            alert('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ' + err);
          });
        }

        document.getElementById('startScanBtn').textContent = 'ğŸ”„ Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø³Ø­...';
        document.getElementById('startScanBtn').disabled = true;
      }

      // QR scan success handler
      function onScanSuccess(decodedText, decodedResult) {
        // Play beep sound
        playBeep();

        // Stop scanning
        if (html5QrCode) {
          html5QrCode.stop().then(() => {
            console.log('Scanner stopped');
          }).catch(err => {
            console.error('Error stopping scanner:', err);
          });
        }

        // Store the scanned repair ID
        const repairId = decodedText.trim();

        // Show loading overlay while checking
        document.getElementById('loadingOverlay').style.display = 'flex';

        // Check if repair ID already exists in system
        checkRepairIdExists(repairId);
      }

      // Check if repair ID already exists
      async function checkRepairIdExists(repairId) {
        try {
          const result = await api.searchByQRCode(repairId);
          document.getElementById('loadingOverlay').style.display = 'none';

          if (result.exists) {
            // Repair ID already exists - show error
            const repair = result.repair;
            alert('âŒ Ø®Ø·Ø£: Ø±Ù…Ø² QR Ù‡Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…!\n\n' +
                  'Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ' + repair.repairId + '\n' +
                  'Ø§Ù„Ø¹Ù…ÙŠÙ„: ' + repair.customerName + '\n' +
                  'Ø§Ù„Ø­Ø§Ù„Ø©: ' + repair.repairStatus + '\n\n' +
                  'ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù…Ø² QR Ø¬Ø¯ÙŠØ¯ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯.');

            // Reset scanner UI
            document.getElementById('startScanBtn').style.display = 'inline-block';
            document.getElementById('startScanBtn').disabled = false;
            document.getElementById('startScanBtn').textContent = 'ğŸ“¸ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­';

            return;
          }

          // Repair ID doesn't exist (404) - proceed with form
          proceedWithNewRepair(repairId);
        } catch (error) {
          document.getElementById('loadingOverlay').style.display = 'none';

          // Network error, auth error, or server error - DO NOT proceed
          console.error('Failed to check repair ID:', error);
          alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…!\n\n' +
                'Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù…Ø² QR.\n' +
                'Ø§Ù„Ø®Ø·Ø£: ' + error.message + '\n\n' +
                'ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');

          // Reset scanner UI to allow retry
          document.getElementById('startScanBtn').style.display = 'inline-block';
          document.getElementById('startScanBtn').disabled = false;
          document.getElementById('startScanBtn').textContent = 'ğŸ“¸ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­';
        }
      }

      // Proceed with new repair after validation
      function proceedWithNewRepair(repairId) {
        scannedRepairId = repairId;

        // Update UI to show scanned ID
        document.getElementById('scannedRepairId').textContent = scannedRepairId;
        document.getElementById('scannedIdDisplay').style.display = 'block';
        document.getElementById('qrScannerCard').classList.add('scanned');
        document.getElementById('scannerTitle').textContent = 'âœ… ØªÙ… Ø§Ù„Ù…Ø³Ø­ Ø¨Ù†Ø¬Ø§Ø­';
        document.getElementById('startScanBtn').style.display = 'none';

        // Enable all form fields
        enableFormFields();

        // Scroll to form
        document.getElementById('formCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      // Submit repair form to API
      async function submitRepairForm(formData, imageFile, submitBtn) {
        try {
          // Create FormData for multipart file upload
          const formDataToSend = new FormData();

          // Add form fields
          formDataToSend.append('customerName', formData.customer);
          formDataToSend.append('phone', formData.phone);
          formDataToSend.append('device', formData.device);
          formDataToSend.append('branch', formData.branch);
          formDataToSend.append('issue', formData.issue);
          formDataToSend.append('receivedDate', formData.date || new Date().toISOString().split('T')[0]);
          formDataToSend.append('warranty', formData.warranty === 'Ù†Ø¹Ù…');
          if (formData.cost) {
            formDataToSend.append('estimatedCost', formData.cost);
          }
          formDataToSend.append('repairId', formData.repairId);

          // Add image file if present
          if (imageFile) {
            formDataToSend.append('image', imageFile);
          }

          // Debug: Log FormData contents
          console.log('=== FORMDATA TO SEND ===');
          for (let [key, value] of formDataToSend.entries()) {
            console.log(`${key}:`, value, `(type: ${typeof value})`);
          }
          console.log('========================');

          const response = await api.createRepair(formDataToSend);

          // Hide loading
          document.getElementById('loadingOverlay').style.display = 'none';

          // Hide scanner and form
          document.getElementById('qrScannerSection').style.display = 'none';
          document.getElementById('formCard').style.display = 'none';

          // Show success display
          document.getElementById('successRepairId').textContent = response.repairId || formData.repairId;
          document.getElementById('successStatus').textContent = 'Ø§Ù„Ø­Ø§Ù„Ø©: ' + (response.status || 'ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… ÙÙŠ ' + formData.branch);
          document.getElementById('successDisplay').style.display = 'block';

          // Scroll to success display
          document.getElementById('successDisplay').scrollIntoView({ behavior: 'smooth' });
        } catch (error) {
          // Hide loading
          document.getElementById('loadingOverlay').style.display = 'none';

          // Show error
          alert('Ø®Ø·Ø£: ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ - ' + error.message);

          // Re-enable button
          submitBtn.disabled = false;
          submitBtn.textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ ØµÙŠØ§Ù†Ø©';
        }
      }

      // QR scan failure handler (optional)
      function onScanFailure(error) {
        // Handle scan failure silently (too many logs)
        // console.warn(`QR scan error: ${error}`);
      }

      // Enable form fields after QR scan
      function enableFormFields() {
        const formInputs = document.querySelectorAll('#repairForm input, #repairForm textarea, #repairForm select');
        formInputs.forEach(input => {
          input.disabled = false;
        });

        document.getElementById('deviceImage').disabled = false;
        document.getElementById('uploadButtonLabel').style.opacity = '1';
        document.getElementById('uploadButtonLabel').style.cursor = 'pointer';
        document.getElementById('submitBtn').disabled = false;
      }

      // Handle image upload
      document.getElementById('deviceImage').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          // Store the file object (will be sent to server)
          uploadedImageFile = file;

          // Create preview
          const reader = new FileReader();
          reader.onload = function(event) {
            const preview = document.getElementById('imagePreview');
            preview.src = event.target.result;
            preview.style.display = 'block';

            // Show image info
            const sizeKB = (file.size / 1024).toFixed(0);
            document.getElementById('imageInfo').textContent =
              `Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø©: ${sizeKB} ÙƒÙŠÙ„ÙˆØ¨Ø§ÙŠØª`;

            document.getElementById('removeImageBtn').style.display = 'inline-block';
          };

          reader.readAsDataURL(file);
        }
      });

      // Remove image
      document.getElementById('removeImageBtn').addEventListener('click', function() {
        uploadedImageFile = null;
        document.getElementById('imagePreview').style.display = 'none';
        document.getElementById('imageInfo').textContent = '';
        document.getElementById('removeImageBtn').style.display = 'none';
        document.getElementById('deviceImage').value = '';
      });

      // Handle form submission
      function handleSubmit(event) {
        event.preventDefault();

        if (!scannedRepairId) {
          alert('Ø®Ø·Ø£: ÙŠØ¬Ø¨ Ù…Ø³Ø­ Ø±Ù…Ø² QR Ø£ÙˆÙ„Ø§Ù‹');
          return;
        }

        const form = document.getElementById('repairForm');
        const submitBtn = document.getElementById('submitBtn');

        // Disable button and show loading
        submitBtn.disabled = true;
        submitBtn.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
        document.getElementById('loadingOverlay').style.display = 'flex';

        // Prepare form data - collect values directly from form elements
        // (FormData skips disabled fields, so we collect manually)
        const formData = {
          customer: document.querySelector('textarea[name="customer"]').value,
          phone: document.querySelector('input[name="phone"]').value,
          device: document.querySelector('textarea[name="device"]').value,
          branch: document.querySelector('select[name="branch"]').value,
          issue: document.querySelector('textarea[name="issue"]').value,
          date: document.getElementById('date').value,
          warranty: document.querySelector('select[name="warranty"]').value,
          repairId: scannedRepairId
        };

        // Debug: Log form data
        console.log('=== FORM DATA DEBUG ===');
        console.log('formData object:', formData);
        console.log('uploadedImageFile:', uploadedImageFile);
        console.log('=======================');

        // Submit to REST API (pass file separately)
        submitRepairForm(formData, uploadedImageFile, submitBtn);
      }

      // Start new repair
      function startNewRepair() {
        // Reset everything
        scannedRepairId = null;
        uploadedImageFile = null;

        // Reset form
        document.getElementById('repairForm').reset();
        document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;
        document.getElementById('imagePreview').style.display = 'none';
        document.getElementById('imageInfo').textContent = '';
        document.getElementById('removeImageBtn').style.display = 'none';

        // Disable form fields again
        const formInputs = document.querySelectorAll('#repairForm input, #repairForm textarea, #repairForm select');
        formInputs.forEach(input => {
          input.disabled = true;
        });
        document.getElementById('deviceImage').disabled = true;
        document.getElementById('uploadButtonLabel').style.opacity = '0.5';
        document.getElementById('uploadButtonLabel').style.cursor = 'not-allowed';
        document.getElementById('submitBtn').disabled = true;

        // Reset scanner UI
        document.getElementById('scannedIdDisplay').style.display = 'none';
        document.getElementById('qrScannerCard').classList.remove('scanned');
        document.getElementById('scannerTitle').textContent = 'ğŸ“· Ø§Ù…Ø³Ø­ Ø±Ù…Ø² QR Ø§Ù„Ù…Ø·Ø¨ÙˆØ¹ Ù…Ø³Ø¨Ù‚Ø§Ù‹';
        document.getElementById('startScanBtn').style.display = 'inline-block';
        document.getElementById('startScanBtn').disabled = false;
        document.getElementById('startScanBtn').textContent = 'ğŸ“¸ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­';

        // Show scanner and form, hide success
        document.getElementById('qrScannerSection').style.display = 'block';
        document.getElementById('formCard').style.display = 'block';
        document.getElementById('successDisplay').style.display = 'none';

        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      // Stop camera when page is hidden or user navigates away
      function stopCamera() {
        if (html5QrCode && html5QrCode.isScanning) {
          html5QrCode.stop().then(() => {
            console.log('Camera stopped due to page navigation/hide');
            const startBtn = document.getElementById('startScanBtn');
            if (startBtn) {
              startBtn.textContent = 'ğŸ“¸ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­';
              startBtn.disabled = false;
            }
          }).catch(err => {
            console.error('Error stopping camera:', err);
          });
        }
      }

      // Add event listeners for page visibility and navigation
      document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
          stopCamera();
        }
      });

      window.addEventListener('beforeunload', function() {
        stopCamera();
      });

      window.addEventListener('pagehide', function() {
        stopCamera();
      });
    </script>
  </body>
</html>
